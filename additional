void run_toxic_analysis(void) {
    // 必须先跑过 Stage 2
    if (!analysis_data.text_filtered) {
        printf("No text filtered. Please load and process a file first.\n");
        return;
    }

    char filename_to_use[256] = "";
    bool need_reprocess = false;
    bool manual_source_match = false;
    bool saved_without_normalisation = false;

    // 统一算出“手动文件名”
    const char* manual_name =
        (strlen(current_manual_filtered_filename) > 0)
        ? current_manual_filtered_filename
        : "filtered_words.txt";

    // ===== 1) 如果有手动保存过，先读头部元数据 =====
    if (user_manually_saved_current_session) {
        FILE* f = fopen(manual_name, "r");
        if (f) {
            char line[512];
            char source_path[256] = "";

            while (fgets(line, sizeof(line), f)) {
                line[strcspn(line, "\r\n")] = 0;
                if (line[0] != '#') break; // 到正文就停

                if (strstr(line, "TextNormalisation: disabled"))
                    saved_without_normalisation = true;
                else if (strstr(line, "TextNormalisation: enabled"))
                    saved_without_normalisation = false;
                else if (!strncmp(line, "# SourceFile:", 13)) {
                    const char* p = line + 13;
                    while (*p == ' ' || *p == '\t') p++;
                    strncpy(source_path, p, sizeof(source_path) - 1);
                    source_path[sizeof(source_path) - 1] = '\0';
                }
            }

            if (source_path[0] && current_filename[0] &&
                strcmp(source_path, current_filename) == 0) {
                manual_source_match = true;
            }
            fclose(f);
        }
    }

    bool using_manual_file = user_manually_saved_current_session && manual_source_match;

    // ===== 2) 决定用哪一个 filtered word 文件 =====
    if (using_manual_file) {
        if (saved_without_normalisation) {
            printf("\nWARNING: Your filtered word list was saved WITHOUT Text Normalisation.\n");
            printf("This means abbreviations and Leet Speak won't be expanded.\n");
            printf("Do you want to:\n");
            printf("1. Use the non-normalised file (faster, less accurate)\n");
            printf("2. Re-process with Text Normalisation (recommended)\n");
            printf("Enter your option (1-2): ");

            char option;
            scanf(" %c", &option);   // 前面加空格吞掉残留的换行

            if (option == '1') {
                printf("\nUsing non-normalised file for analysis: %s\n", manual_name);
                strcpy(filename_to_use, manual_name);
            }
            else {
                printf("\nRe-processing with Text Normalisation...\n");
                if (!analysis_data.variant_processing_enabled) {
                    analysis_data.variant_processing_enabled = true;
                    need_reprocess = true;
                }
                strcpy(filename_to_use, "filtered_words_normalised.txt");
            }
        }
        else {
            printf("Using your manually saved file: %s\n", manual_name);
            strcpy(filename_to_use, manual_name);
        }
    }
    else {
        printf("No matching manually saved filtered word list for this file.\n");
        printf("Auto-saving normalised word list for toxic analysis...\n");

        if (!analysis_data.variant_processing_enabled) {
            printf("Enabling Text Normalisation for better accuracy...\n");
            analysis_data.variant_processing_enabled = true;
            need_reprocess = true;
        }
        strcpy(filename_to_use, "filtered_words_auto_saved.txt");
    }

    // ===== 3) 必要时重新 normalise =====
    if (need_reprocess) {
        reprocess_with_variants();
    }

    // ===== 4) 把当前版本的 filtered list 写到磁盘（自动文件） =====
    if (!using_manual_file ||
        strcmp(filename_to_use, "filtered_words_normalised.txt") == 0) {
        save_filtered_word_list_auto(filename_to_use);
        printf("Auto-saved word list: %s\n", filename_to_use);
    }

    // ===== 5) 真正做毒性分析 =====
    reset_toxic_counts();
    printf("Starting toxic analysis using: %s\n", filename_to_use);

    FILE* file = fopen(filename_to_use, "r");
    if (!file) {
        printf("Error: Cannot open filtered word list file: %s\n", filename_to_use);
        return;
    }

    char word[MAX_WORD_LENGTH];
    int word_count = 0;

    while (fgets(word, sizeof(word), file) && word_count < MAX_WORDS) {
        word[strcspn(word, "\r\n")] = 0;
        if (strlen(word) > 0) {
            detect_toxic_content(word);
            word_count++;
        }
    }
    fclose(file);

    printf("Analysed %d words from file\n", word_count);

    detect_toxic_phrases();
    calculate_toxicity_density();
    printf("Toxic analysis completed.\n");
}
